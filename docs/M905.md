# M905 — Calibrate & persist probe enable-off height

Summary
- Calibrates the Z height at which the probe becomes inactive (enable-off).
- Optionally persists the calibrated enable-off height plus tuning parameters (margin and settle delay) to EEPROM.

Syntax
- M905 Z<start_z> [M<margin>] [S<settle_ms>] [P<0|1>]

Parameters
- Z = start Z (mm) (optional) — default: `PROBE_EN_OFF_HEIGHT_DEFAULT` (compile-time default).
- M = safety margin (mm) (optional) — default: `PROBE_EN_OFF_MARGIN` (compile-time default).
- S = settle delay (ms) between step adjustments (optional) — default: `M905_STEP_SETTLE_MS` (compile-time default).
- P = persist flag (0 or 1). If `P1`, the provided `M` and `S` values are stored to EEPROM along with the calibrated height.

Behavior
- Requires homed axes for safe Z motion. M905 will abort if homing is needed.
- Moves to `Z` and performs a slow, stepped descent until the probe triggers. On trigger the command steps back up to the previous height and verifies the probe clears.
- If compiled with `PROBE_TARE_ONLY_WHILE_INACTIVE` and the probe is found active at the start, M905 performs an iterative upward search (1 mm steps) up to 20 mm above the start Z to find a Z where the probe is inactive before proceeding.
- On success M905 sets the runtime `probe_en_off_height = detected_z + margin`. If `P1` is provided it will also persist `probe_en_off_margin` and `m905_step_settle_ms` to EEPROM (note: EEPROM version bumped to `V92` in this branch).

Examples
- `M905 Z15` — calibrate starting at 15 mm using default margin/settle.
- `M905 Z15 M1.2 S60 P1` — calibrate using a 1.2 mm margin and a 60 ms settle delay, and persist the measured values and tuned parameters to EEPROM.

Safety notes
- Always home (`G28`) before running M905.
- If M905 cannot find a clean probe transition it aborts and restores the original Z position.
- After persisting, the stored enable-off height + margin will be used at runtime to raise the nozzle before taring/probing in order to avoid ISR-latched or transient probe activations.

Implementation notes
- The command was implemented in `src/gcode/custom/M905.cpp`.
- Runtime settings are exposed via `MarlinSettings` accessors and saved by `settings.save()`.
- The runtime pre-probe clearance helper is `probe_safe_clearance_for_z()` in `src/module/probe.cpp` which uses the stored `probe_en_off_height` and `probe_en_off_margin` when they are available.


How to Test
See .test/README_M905_TEST.md